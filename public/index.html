<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Sulama Asistanƒ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PDF i√ßin jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --bg: #f3f6fb;
      --bg-alt: #ffffff;
      --primary: #1b8a5a;
      --primary-soft: #e1f5ec;
      --border: #d4dce8;
      --text: #1c2533;
      --text-soft: #6b7280;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 14px 35px rgba(15, 23, 42, 0.12);
      --shadow-light: 0 8px 20px rgba(15, 23, 42, 0.08);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #e0f7f4, #f3f6fb);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }
    .app-shell {
      max-width: 1200px;
      width: 100%;
      margin: 24px;
      background: linear-gradient(135deg, #f9fafb, #eef2ff);
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }
    header.app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 22px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      background: linear-gradient(120deg, #0f766e, #16a34a);
      color: white;
    }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand-logo {
      width: 34px; height: 34px; border-radius: 12px;
      background: radial-gradient(circle at 30% 20%, #bbf7d0, #22c55e);
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 18px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.18);
    }
    .brand-text h1 { font-size: 18px; font-weight: 700; letter-spacing: 0.02em; }
    .brand-text p { font-size: 12px; opacity: 0.85; }
    .header-badge {
      font-size: 12px; padding: 6px 12px; border-radius: 999px;
      background: rgba(15, 23, 42, 0.2);
      border: 1px solid rgba(226, 232, 240, 0.6);
      display: flex; align-items: center; gap: 6px;
    }
    .header-badge span.led {
      width: 8px; height: 8px; border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.35);
    }
    main.app-main {
      display: grid;
      grid-template-columns: 1.6fr 1fr;
      min-height: 520px;
    }
    @media (max-width: 960px) {
      main.app-main { grid-template-columns: 1fr; }
      .project-panel { border-left: none; border-top: 1px solid var(--border); }
    }
    .chat-section {
      display: flex; flex-direction: column;
      padding: 16px;
      background: radial-gradient(circle at top, #e5f9f3, #eef2ff);
    }
    .chat-header-line {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 10px;
    }
    .chat-title {
      font-size: 14px; font-weight: 600;
      display: flex; gap: 8px; align-items: center; color: #0f172a;
    }
    .chat-title span.dot {
      width: 8px; height: 8px; border-radius: 999px; background: #22c55e;
    }
    .chat-sub { font-size: 12px; color: var(--text-soft); }
    .chat-window {
      flex: 1;
      border-radius: var(--radius-lg);
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: var(--shadow-light);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 580px;
    }
    .messages { flex: 1; overflow-y: auto; padding-right: 4px; scroll-behavior: smooth; }
    .message { max-width: 90%; margin-bottom: 8px; display: flex; gap: 8px; }
    .message.assistant { justify-content: flex-start; }
    .message.user { justify-content: flex-end; }
    .bubble {
      padding: 8px 11px;
      border-radius: 14px;
      font-size: 13px;
      line-height: 1.4;
      word-break: break-word;
    }
    .assistant .bubble {
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-bottom-left-radius: 4px;
      color: #0f172a;
    }
    .user .bubble {
      background: #16a34a;
      color: white;
      border-bottom-right-radius: 4px;
    }
    .thinking {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 12px; color: var(--text-soft);
      padding: 4px 8px; border-radius: 999px;
      background: #e5f3ff; margin-top: 2px;
    }
    .thinking-dot {
      width: 6px; height: 6px; border-radius: 999px;
      background: #38bdf8;
      animation: pulse 1.2s infinite ease-in-out;
    }
    .thinking-dot:nth-child(2) { animation-delay: 0.15s; }
    .thinking-dot:nth-child(3) { animation-delay: 0.3s; }
    @keyframes pulse {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1.1); opacity: 1; }
    }
    .chat-input {
      display: flex; align-items: center; gap: 8px;
      margin-top: 8px; padding-top: 8px;
      border-top: 1px solid rgba(148, 163, 184, 0.3);
    }
    .chat-input input[type="text"] {
      flex: 1; padding: 9px 10px; border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 13px; outline: none; background: #f9fafb;
    }
    .chat-input input[type="text"]:focus {
      border-color: #16a34a;
      box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.25);
      background: #ffffff;
    }
    .chat-input button {
      border: none; padding: 9px 14px; border-radius: 999px;
      font-size: 13px; font-weight: 600; cursor: pointer;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: white; display: inline-flex; align-items: center; gap: 6px;
      box-shadow: 0 10px 18px rgba(22, 163, 74, 0.35);
    }
    .chat-input button:disabled {
      opacity: 0.6; cursor: not-allowed; box-shadow: none;
    }
    .project-panel {
      padding: 14px 16px;
      background: #f8fafc;
      border-left: 1px solid rgba(148, 163, 184, 0.35);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .panel-header h2 { font-size: 14px; font-weight: 600; color: #0f172a; }
    .panel-header button {
      border: none;
      background: rgba(15, 118, 110, 0.06);
      color: #0369a1;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    .panel-section {
      background: white;
      border-radius: 14px;
      padding: 8px 10px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.04);
      margin-bottom: 6px;
    }
    .panel-section h3 { font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #0f172a; }
    .panel-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 8px;
      font-size: 11px;
    }
    .panel-label { color: var(--text-soft); }
    .panel-value { font-weight: 600; color: #111827; }
    .pill {
      display: inline-flex;
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 10px;
      margin: 2px 2px 0 0;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #f1f5f9;
    }
    .maliyet { font-size: 20px; font-weight: 700; color: #0f766e; }
    .maliyet-sub { font-size: 11px; color: var(--text-soft); }
    .panel-note { font-size: 11px; color: var(--text-soft); margin-top: 4px; }

    .wizard-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 16px;
      overflow-y: auto;
      z-index: 10000;
    }
    .wizard-container {
      width: 100%;
      max-width: 660px;
      background: #f9fafb;
      border-radius: 22px;
      padding: 18px 20px 16px;
      box-shadow: 0 24px 55px rgba(15, 23, 42, 0.45);
      border: 1px solid rgba(148, 163, 184, 0.6);
    }
    .wizard-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .wizard-header-left h2 { font-size: 18px; margin-bottom: 4px; color: #0f172a; }
    .wizard-header-left p { font-size: 12px; color: var(--text-soft); }
    .wizard-step-badges {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: #e5f3ff;
      border: 1px solid rgba(59, 130, 246, 0.4);
      height: fit-content;
    }
    .wizard-body {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 12px;
      margin-bottom: 8px;
    }
    @media (max-width: 768px) {
      .wizard-body { grid-template-columns: 1fr; }
    }
    .wizard-form-group { margin-bottom: 8px; }
    .wizard-form-group label {
      font-size: 12px; font-weight: 600;
      display: block; margin-bottom: 4px; color: #111827;
    }
    .wizard-sub { font-size: 11px; color: var(--text-soft); margin-bottom: 4px; }
    .wizard-input {
      width: 100%; padding: 6px 8px; border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      font-size: 12px; outline: none; background: #f9fafb;
    }
    .wizard-range-row { display: flex; align-items: center; gap: 8px; }
    .wizard-range-row input[type="range"] { flex: 1; }
    .wizard-range-value {
      font-size: 12px; font-weight: 600;
      padding: 4px 8px; border-radius: 999px;
      background: #e5f3ff; border: 1px solid rgba(59, 130, 246, 0.4);
    }
    .wizard-options {
      display: flex; flex-wrap: wrap; gap: 6px; margin-top: 2px;
    }
    .wizard-option {
      flex: 1 1 calc(50% - 6px);
      min-width: 90px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 6px 7px;
      font-size: 11px;
      cursor: pointer;
      background: #f8fafc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .wizard-option span.label { font-weight: 500; }
    .wizard-option span.tag { font-size: 10px; color: var(--text-soft); }
    .wizard-option.active {
      background: #dcfce7;
      border-color: #16a34a;
      box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.35);
    }
    .wizard-mini-summary {
      font-size: 11px;
      background: white;
      border-radius: 14px;
      padding: 8px 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.08);
    }
    .wizard-mini-summary h3 { font-size: 11px; font-weight: 600; margin-bottom: 4px; }
    .wizard-mini-summary ul { list-style: none; }
    .wizard-mini-summary li { margin-bottom: 3px; }
    .pill-green {
      display: inline-flex;
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 10px;
      background: #dcfce7;
      border: 1px solid rgba(34, 197, 94, 0.6);
      color: #166534;
      margin-right: 2px;
    }
    .wizard-footer {
      display: flex; justify-content: space-between;
      align-items: center; margin-top: 4px;
      font-size: 11px; color: var(--text-soft);
    }
    .wizard-footer-right { display: flex; gap: 6px; }
    .btn-text {
      border: none; background: transparent;
      font-size: 11px; color: var(--text-soft);
      cursor: pointer; text-decoration: underline;
    }
    .btn-primary {
      border: none;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: white;
      font-size: 13px; font-weight: 600;
      padding: 7px 14px;
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex; align-items: center; gap: 6px;
      box-shadow: 0 14px 24px rgba(22, 163, 74, 0.4);
    }
    .btn-primary:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      box-shadow: none;
    }
  </style>

  <!-- PWA / Manifest -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#16a34a" />

  <!-- iOS i√ßin (Safari ikon ve fullscreen) -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />

</head>
<body>

  <!-- √úst Beta bar -->
  <div id="beta-warning" 
     style="
        width: 100%;
        padding: 10px 18px;
        background: #fff7d6;
        border-bottom: 1px solid #f0d98c;
        color: #5e4a1b;
        font-size: 13px;
        font-family: system-ui, sans-serif;
        text-align: center;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 9999;
     ">
    üß™ <strong>Sulama Asistanƒ± Beta S√ºr√ºm√º</strong> ‚Äì Yapay zek√¢ desteklidir; zaman zaman hatalƒ± veya eksik bilgiler verebilir.
    L√ºtfen √∂nerileri uygulamadan √∂nce kontrol edin.
    
    <button
        onclick="closeBetaWarning()"
        style="
            margin-left: 8px;
            background: none;
            border: none;
            cursor: pointer;
            color: #7a5f2a;
            text-decoration: underline;
            font-size: 12px;
        ">
        Kapat
    </button>
  </div>

  <!-- Wizard -->
  <div class="wizard-overlay" id="wizardOverlay">
    <div class="wizard-container">
      <div class="wizard-header">
        <div class="wizard-header-left">
          <h2>Bah√ßen i√ßin hƒ±zlƒ± bir proje tasarlayalƒ±m</h2>
          <p>√ñnce birka√ß kƒ±sa soru soracaƒüƒ±m, sonra Sulama Asistanƒ± detaylƒ± tasarƒ±m, malzeme listesi ve maliyet hesabƒ±nƒ± √ßƒ±karacak.</p>
        </div>
        <div class="wizard-step-badges">1/1 Proje √ñzeti</div>
      </div>

      <div class="wizard-body">
        <!-- SOL TARAF: SORULAR -->
        <form id="wizardForm">
          <!-- Alan -->
          <div class="wizard-form-group">
            <label for="areaRange">Alan (m¬≤)</label>
            <p class="wizard-sub">Tahmini alanƒ± girmen yeterli, sonra sohbet i√ßinde revize edebiliriz.</p>
            <div class="wizard-range-row">
              <input type="range" id="areaRange" min="50" max="2000" step="10" value="200" />
              <div class="wizard-range-value">
                <span id="areaValue">200</span> m¬≤
              </div>
            </div>
          </div>

          <!-- Bah√ße ≈üekli -->
          <div class="wizard-form-group">
            <label>Bah√ße ≈üekli</label>
            <div class="wizard-options" data-field="shape">
              <div class="wizard-option active" data-value="dikdortgen">
                <span class="label">Dikd√∂rtgen</span><span class="tag">En yaygƒ±n</span>
              </div>
              <div class="wizard-option" data-value="L">
                <span class="label">L ≈üekilli</span><span class="tag">K√∂≈üe bah√ße</span>
              </div>
              <div class="wizard-option" data-value="kare">
                <span class="label">Kare</span><span class="tag">Basit plan</span>
              </div>
              <div class="wizard-option" data-value="serbest">
                <span class="label">Serbest</span><span class="tag">D√ºzensiz</span>
              </div>
            </div>
          </div>

          <!-- Su kaynaƒüƒ± -->
          <div class="wizard-form-group">
            <label>Su kaynaƒüƒ±</label>
            <div class="wizard-options" data-field="waterSource">
              <div class="wizard-option active" data-value="sebekesu">
                <span class="label">≈ûebeke suyu</span><span class="tag">Ev su hattƒ±</span>
              </div>
              <div class="wizard-option" data-value="kuyu">
                <span class="label">Kuyu</span><span class="tag">Dalgƒ±√ß pompa</span>
              </div>
              <div class="wizard-option" data-value="depo">
                <span class="label">Depo + hidrofor</span><span class="tag">Basƒ±n√ß kontroll√º</span>
              </div>
              <div class="wizard-option" data-value="sondaj">
                <span class="label">Sondaj</span><span class="tag">Y√ºksek debi</span>
              </div>
            </div>
          </div>

          <!-- Basƒ±n√ß -->
          <div class="wizard-form-group">
            <label>√áalƒ±≈üma basƒ±ncƒ±</label>
            <p class="wizard-sub">Bilmiyorsan ‚ÄúBilmiyorum‚Äù se√ßili kalabilir. Sonradan netle≈ütiririz.</p>
            <div class="wizard-options" data-field="pressureMode">
              <div class="wizard-option active" data-value="unknown" id="pressureUnknown">
                <span class="label">Bilmiyorum</span><span class="tag">Varsayƒ±lan hesap</span>
              </div>
              <div class="wizard-option" data-value="known" id="pressureKnown">
                <span class="label">Belli</span><span class="tag">Bar cinsinden</span>
              </div>
            </div>
            <input
              class="wizard-input"
              type="number"
              step="0.1"
              min="0.5"
              max="8"
              id="pressureInput"
              placeholder="√ñrn: 3.0 bar"
              style="margin-top:6px; display:none;"
            />
          </div>

          <!-- Sistem tipi -->
          <div class="wizard-form-group">
            <label>Sistem tipi</label>
            <div class="wizard-options" data-field="systemType">
              <div class="wizard-option active" data-value="sprink">
                <span class="label">Sprink</span><span class="tag">Klasik √ßim</span>
              </div>
              <div class="wizard-option" data-value="rotor">
                <span class="label">Rotor</span><span class="tag">Geni≈ü alan</span>
              </div>
              <div class="wizard-option" data-value="damla">
                <span class="label">Damla</span><span class="tag">Aƒüa√ß / √ßalƒ±</span>
              </div>
              <div class="wizard-option" data-value="karisik">
                <span class="label">Karƒ±≈üƒ±k</span><span class="tag">Sprink + damla</span>
              </div>
            </div>
          </div>

          <!-- Otomasyon -->
          <div class="wizard-form-group">
            <label>Otomasyon</label>
            <div class="wizard-options" data-field="automation">
              <div class="wizard-option active" data-value="evet">
                <span class="label">Tam otomatik</span><span class="tag">Programlanabilir cihaz</span>
              </div>
              <div class="wizard-option" data-value="hayir">
                <span class="label">Yarƒ± otomatik / manuel</span><span class="tag">Musluk kontroll√º</span>
              </div>
            </div>
          </div>
        </form>

        <!-- SAƒû TARAF: √ñZET -->
        <div class="wizard-mini-summary" id="wizardSummary">
          <h3>√ñzet</h3>
          <ul>
            <li><span class="pill-green" id="summaryArea">200 m¬≤ alan</span></li>
            <li><span class="pill-green" id="summaryShape">Dikd√∂rtgen bah√ße</span></li>
            <li><span class="pill-green" id="summaryWaterSource">≈ûebeke suyu</span></li>
            <li><span class="pill-green" id="summarySystemType">Sprink sistem</span></li>
            <li><span class="pill-green" id="summaryAutomation">Tam otomatik</span></li>
          </ul>
          <p style="margin-top:6px;">Bu bilgilerle Sulama Asistanƒ±:</p>
          <ul style="margin-top:4px; padding-left:14px;">
            <li>Zone sayƒ±sƒ±nƒ± ve boru √ßaplarƒ±nƒ± hesaplayacak,</li>
            <li>Sprink / damla / rotor adetlerini √ßƒ±karacak,</li>
            <li>Tahmini malzeme listesi ve maliyet verecek.</li>
          </ul>
        </div>
      </div>

      <div class="wizard-footer">
        <div>ƒ∞lk etapta tahmini deƒüerler yeterli. Sohbet sƒ±rasƒ±nda bah√ßeye √∂zel detaylarƒ± netle≈ütirebiliriz.</div>
        <div class="wizard-footer-right">
          <button type="button" class="btn-text" id="skipWizardBtn">Formu atla</button>
          <button type="button" class="btn-primary" id="startChatBtn">Projeyi ba≈ülat ‚Æï</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ana Uygulama -->
  <div class="app-shell">
    <header class="app-header">
      <div class="brand">
        <div class="brand-logo">üíß</div>
        <div class="brand-text">
          <h1>Sulama Asistanƒ±</h1>
          <p>Villa ve peyzaj bah√ßeleri i√ßin akƒ±llƒ± sulama danƒ±≈ümanƒ±</p>
        </div>
      </div>
      <div class="header-badge">
        <span class="led"></span>
        <span>Beta ‚Ä¢ T√ºrkiye ko≈üullarƒ±na g√∂re hesaplama</span>
      </div>
    </header>

    <main class="app-main">
      <section class="chat-section">
        <div class="chat-header-line">
          <div>
            <div class="chat-title">
              <span class="dot"></span>
              <span>Sohbet Alanƒ±</span>
            </div>
            <div class="chat-sub">Bah√ßeni, su kaynaƒüƒ±nƒ± ve beklentini anlat; gerisini asistan halletsin.</div>
          </div>
        </div>

        <div class="chat-window">
          <div id="messages" class="messages"></div>
          <div id="thinkingIndicator" class="thinking" style="display:none;">
            <div class="thinking-dot"></div>
            <div class="thinking-dot"></div>
            <div class="thinking-dot"></div>
            <span>Sulama Asistanƒ± d√º≈ü√ºn√ºyor...</span>
          </div>
          <form id="chatForm" class="chat-input">
            <input
              id="userInput"
              type="text"
              autocomplete="off"
              placeholder="√ñrn: 300 m¬≤ dikd√∂rtgen bah√ßem var, ≈üebeke suyu ile tam otomatik sistem istiyorum."
            />
            <button id="sendBtn" type="submit">G√∂nder ‚Æï</button>
          </form>
        </div>
      </section>

      <aside class="project-panel">
        <div class="panel-header">
          <h2>Proje √ñzeti</h2>
        </div>

        <div class="panel-section">
          <h3>Bah√ße Bilgileri</h3>
          <div class="panel-grid">
            <div class="panel-label">Alan</div>
            <div class="panel-value" id="panelArea">200 m¬≤</div>
            <div class="panel-label">≈ûekil</div>
            <div class="panel-value" id="panelShape">Dikd√∂rtgen</div>
            <div class="panel-label">Su kaynaƒüƒ±</div>
            <div class="panel-value" id="panelWaterSource">≈ûebeke suyu</div>
            <div class="panel-label">Sistem tipi</div>
            <div class="panel-value" id="panelSystemType">Sprink</div>
            <div class="panel-label">Otomasyon</div>
            <div class="panel-value" id="panelAutomation">Tam otomatik</div>
          </div>
        </div>

        <div class="panel-section">
          <h3>Tahmini Zone / Debi</h3>
          <div class="panel-grid">
            <div class="panel-label">Zone sayƒ±sƒ±</div>
            <div class="panel-value" id="panelZones">3</div>
            <div class="panel-label">Tahmini debi</div>
            <div class="panel-value" id="panelFlow">2,5 m¬≥/saat</div>
            <div class="panel-label">Ana boru √ßapƒ±</div>
            <div class="panel-value" id="panelMainPipe">32 mm</div>
            <div class="panel-label">Lateral boru</div>
            <div class="panel-value" id="panelLateralPipe">20 mm</div>
          </div>
          <p class="panel-note">Bu deƒüerler, wizard bilgilerine g√∂re ilk tahmindir; sohbet sƒ±rasƒ±nda netle≈ütirilir.</p>
        </div>

        <div class="panel-section">
          <h3>Tahmini Maliyet</h3>
          <div class="maliyet" id="panelCost">‚Äì</div>
          <div class="maliyet-sub" id="panelCostNote">Malzeme listesi √ßƒ±karƒ±ldƒ±ƒüƒ±nda tahmini maliyet hesaplanƒ±r.</div>
        </div>

        <div class="panel-section">
          <h3>Teklif / PDF</h3>
          <button id="downloadOfferBtn" class="btn-primary" type="button" style="width:100%; justify-content:center;">
            Teklif formunu indir (PDF)
          </button>
          <p class="panel-note">√ñnce bah√ßen i√ßin bir proje ve malzeme listesi olu≈ütur; ardƒ±ndan PDF teklif al.</p>
        </div>
      </aside>
    </main>
  </div>

  <!-- JS -->
  <script>
    // Beta bar kapatma
    function closeBetaWarning() {
      const bar = document.getElementById("beta-warning");
      if (bar) {
        bar.style.display = "none";
        document.body.style.paddingTop = "0px";
      }
    }

    // Global durum
    const projectState = {
      area: 200,
      shape: "dikdortgen",
      waterSource: "sebekesu",
      systemType: "sprink",
      automation: "evet",
      pressureMode: "unknown",
      pressureBar: null,
    };

    let conversationHistory = [];
    let lastOfferData = null;

    // DOM referanslarƒ±
    const wizardOverlay = document.getElementById("wizardOverlay");
    const areaRange = document.getElementById("areaRange");
    const areaValue = document.getElementById("areaValue");
    const pressureInput = document.getElementById("pressureInput");
    const skipWizardBtn = document.getElementById("skipWizardBtn");
    const startChatBtn = document.getElementById("startChatBtn");

    const summaryArea = document.getElementById("summaryArea");
    const summaryShape = document.getElementById("summaryShape");
    const summaryWaterSource = document.getElementById("summaryWaterSource");
    const summarySystemType = document.getElementById("summarySystemType");
    const summaryAutomation = document.getElementById("summaryAutomation");

    const panelArea = document.getElementById("panelArea");
    const panelShape = document.getElementById("panelShape");
    const panelWaterSource = document.getElementById("panelWaterSource");
    const panelSystemType = document.getElementById("panelSystemType");
    const panelAutomation = document.getElementById("panelAutomation");
    const panelZones = document.getElementById("panelZones");
    const panelFlow = document.getElementById("panelFlow");
    const panelMainPipe = document.getElementById("panelMainPipe");
    const panelLateralPipe = document.getElementById("panelLateralPipe");
    const panelCost = document.getElementById("panelCost");
    const panelCostNote = document.getElementById("panelCostNote");
    const downloadOfferBtn = document.getElementById("downloadOfferBtn");

    const messagesDiv = document.getElementById("messages");
    const chatForm = document.getElementById("chatForm");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const thinkingIndicator = document.getElementById("thinkingIndicator");

    // Wizard alanƒ±
    areaRange.addEventListener("input", () => {
      const val = Number(areaRange.value);
      projectState.area = val;
      areaValue.textContent = val;
      summaryArea.textContent = val + " m¬≤ alan";
      updateProjectPanel();
    });

    // Wizard se√ßenekleri
    document.querySelectorAll(".wizard-options").forEach((group) => {
      const field = group.dataset.field;
      group.querySelectorAll(".wizard-option").forEach((opt) => {
        opt.addEventListener("click", () => {
          group.querySelectorAll(".wizard-option").forEach((o) => o.classList.remove("active"));
          opt.classList.add("active");
          const value = opt.dataset.value;

          if (field === "shape") {
            projectState.shape = value;
            const labelMap = { dikdortgen: "Dikd√∂rtgen bah√ße", L: "L ≈üekilli bah√ße", kare: "Kare bah√ße", serbest: "Serbest form" };
            summaryShape.textContent = labelMap[value] || "Belirtilmemi≈ü";
          } else if (field === "waterSource") {
            projectState.waterSource = value;
            const labelMap = {
              sebekesu: "≈ûebeke suyu",
              kuyu: "Kuyu",
              depo: "Depo + hidrofor",
              sondaj: "Sondaj",
            };
            summaryWaterSource.textContent = labelMap[value] || "Belirtilmemi≈ü";
          } else if (field === "systemType") {
            projectState.systemType = value;
            const labelMap = {
              sprink: "Sprink sistem",
              rotor: "Rotor sistem",
              damla: "Damla sulama",
              karisik: "Karƒ±≈üƒ±k sistem",
            };
            summarySystemType.textContent = labelMap[value] || "Belirtilmemi≈ü";
          } else if (field === "automation") {
            projectState.automation = value;
            summaryAutomation.textContent = value === "evet" ? "Tam otomatik" : "Yarƒ± otomatik / manuel";
          } else if (field === "pressureMode") {
            projectState.pressureMode = value;
            if (value === "known") {
              pressureInput.style.display = "block";
            } else {
              pressureInput.style.display = "none";
              projectState.pressureBar = null;
            }
          }
          updateProjectPanel();
        });
      });
    });

    pressureInput.addEventListener("input", () => {
      const v = Number(pressureInput.value);
      projectState.pressureBar = isNaN(v) ? null : v;
      updateProjectPanel();
    });

    // Paneli g√ºncelle
    function updateProjectPanel() {
      panelArea.textContent = projectState.area + " m¬≤";
      const shapeMap = { dikdortgen: "Dikd√∂rtgen", L: "L ≈üekilli", kare: "Kare", serbest: "Serbest" };
      panelShape.textContent = shapeMap[projectState.shape] || "Belirtilmemi≈ü";

      const waterMap = {
        sebekesu: "≈ûebeke suyu",
        kuyu: "Kuyu",
        depo: "Depo + hidrofor",
        sondaj: "Sondaj",
      };
      panelWaterSource.textContent = waterMap[projectState.waterSource] || "Belirtilmemi≈ü";

      const sysMap = { sprink: "Sprink", rotor: "Rotor", damla: "Damla", karisik: "Karƒ±≈üƒ±k" };
      panelSystemType.textContent = sysMap[projectState.systemType] || "Belirtilmemi≈ü";
      panelAutomation.textContent = projectState.automation === "evet" ? "Tam otomatik" : "Yarƒ± otomatik / manuel";

      // Basit zone tahmini: 120 m¬≤ / zone
      const approxZones = Math.max(1, Math.round(projectState.area / 120));
      panelZones.textContent = approxZones.toString();

      // Kabaca debi
      const flow = (projectState.area / 80).toFixed(1);
      panelFlow.textContent = flow + " m¬≥/saat";

      // Boru √ßapƒ±
      panelMainPipe.textContent = projectState.area > 350 ? "40 mm" : "32 mm";
      panelLateralPipe.textContent = "20 mm";
    }

    updateProjectPanel();

    // Wizard butonlarƒ±
    function openBetaBar() {
      const bar = document.getElementById("beta-warning");
      if (bar) {
        bar.style.display = "flex";
        document.body.style.paddingTop = bar.offsetHeight + "px";
      }
    }

    startChatBtn.addEventListener("click", () => {
      wizardOverlay.style.display = "none";
      openBetaBar();
      addMessage(
        "assistant",
        "Bah√ße bilgilerini aldƒ±m. Alan: " +
          projectState.area +
          " m¬≤, ≈üekil: " +
          panelShape.textContent +
          ", su kaynaƒüƒ±: " +
          panelWaterSource.textContent +
          ". ≈ûimdi bu bilgilere g√∂re zone planƒ±, boru √ßaplarƒ± ve malzeme listesini √ßƒ±karabiliriz. ƒ∞stersen bah√ßenin √∂zel durumlarƒ±nƒ± (aƒüa√ßlar, teras, eƒüim vb.) de yaz."
      );
      userInput.focus();
    });

    skipWizardBtn.addEventListener("click", () => {
      wizardOverlay.style.display = "none";
      openBetaBar();
      addMessage(
        "assistant",
        "Ho≈ü geldin. Bah√ße alanƒ±nƒ±, su kaynaƒüƒ±nƒ± ve otomasyon isteƒüini yazarsan; sana √∂zel sulama projesi, malzeme listesi ve tahmini maliyet √ßƒ±karacaƒüƒ±m."
      );
      userInput.focus();
    });

    // Mesaj ekleme
    function addMessage(role, text) {
      const wrap = document.createElement("div");
      wrap.className = "message " + role;

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;

      wrap.appendChild(bubble);
      messagesDiv.appendChild(wrap);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      conversationHistory.push({ role, content: text });
    }

    // Chat g√∂nderme
    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = userInput.value.trim();
      if (!text) return;

      addMessage("user", text);
      userInput.value = "";
      sendBtn.disabled = true;
      thinkingIndicator.style.display = "inline-flex";

      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: text,
            history: conversationHistory,
            projectState,
          }),
        });

        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const reply = data.reply || data.message || data.answer || "Sunucudan yanƒ±t alƒ±ndƒ± ama metin bulunamadƒ±.";
        addMessage("assistant", reply);

        if (data.projectState) {
          Object.assign(projectState, data.projectState);
          updateProjectPanel();
        }
        if (data.offerSummary) {
          lastOfferData = data.offerSummary;
          panelCost.textContent = data.offerSummary.totalText || data.offerSummary.total || "G√ºncellendi";
          panelCostNote.textContent = data.offerSummary.note || "Teklif detaylarƒ± g√ºncellendi.";
        }
      } catch (err) {
        console.error(err);
        addMessage("assistant", "Sunucuyla baƒülantƒ±da bir sorun olu≈ütu. L√ºtfen biraz sonra tekrar dene.");
      } finally {
        sendBtn.disabled = false;
        thinkingIndicator.style.display = "none";
      }
    });

    // Basit PDF
    downloadOfferBtn.addEventListener("click", () => {
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) {
        alert("PDF mod√ºl√º y√ºklenemedi.");
        return;
      }

      const doc = new jsPDF();

      doc.setFontSize(14);
      doc.text("Sulama Asistanƒ± - Teklif √ñzeti", 14, 18);

      doc.setFontSize(11);
      doc.text("Bah√ße Bilgileri:", 14, 30);
      doc.text("Alan: " + projectState.area + " m¬≤", 14, 36);
      doc.text("≈ûekil: " + panelShape.textContent, 14, 42);
      doc.text("Su kaynaƒüƒ±: " + panelWaterSource.textContent, 14, 48);
      doc.text("Sistem tipi: " + panelSystemType.textContent, 14, 54);
      doc.text("Otomasyon: " + panelAutomation.textContent, 14, 60);

      doc.text("Zone sayƒ±sƒ±: " + panelZones.textContent, 14, 70);
      doc.text("Tahmini debi: " + panelFlow.textContent, 14, 76);
      doc.text("Ana boru: " + panelMainPipe.textContent, 14, 82);
      doc.text("Lateral boru: " + panelLateralPipe.textContent, 14, 88);

      if (panelCost.textContent && panelCost.textContent !== "‚Äì") {
        doc.text("Tahmini maliyet: " + panelCost.textContent, 14, 98);
      }

      doc.save("sulama-teklifi.pdf");
    });

    // Sayfa y√ºklendiƒüinde body padding + SW kaydƒ±
    window.addEventListener("load", () => {
      const bar = document.getElementById("beta-warning");
      if (bar) {
        document.body.style.paddingTop = bar.offsetHeight + "px";
      }

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/sw.js")
          .then((reg) => {
            console.log("Service worker kayƒ±tlƒ±:", reg.scope);
          })
          .catch((err) => {
            console.log("Service worker kaydƒ± ba≈üarƒ±sƒ±z:", err);
          });
      }
    });
  </script>
</body>
</html>
