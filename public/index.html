<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Sulama AsistanÄ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PDF iÃ§in jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
<script src="C:\sulamaasistani\Roboto-normal.js"></script>





  <style>
    :root {
      --bg: #f3f6fb;
      --bg-alt: #ffffff;
      --primary: #1b8a5a;
      --primary-soft: #e1f5ec;
      --border: #d4dce8;
      --text: #1c2533;
      --text-soft: #6b7280;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 14px 35px rgba(15, 23, 42, 0.12);
      --shadow-light: 0 8px 20px rgba(15, 23, 42, 0.08);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #e0f7f4, #f3f6fb);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }
    .app-shell {
      max-width: 1200px;
      width: 100%;
      margin: 24px;
      background: linear-gradient(135deg, #f9fafb, #eef2ff);
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }
    header.app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 22px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      background: linear-gradient(120deg, #0f766e, #16a34a);
      color: white;
    }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand-logo {
      width: 34px; height: 34px; border-radius: 12px;
      background: radial-gradient(circle at 30% 20%, #bbf7d0, #22c55e);
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 18px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.18);
    }
    .brand-text h1 { font-size: 18px; font-weight: 700; letter-spacing: 0.02em; }
    .brand-text p { font-size: 12px; opacity: 0.85; }
    .header-badge {
      font-size: 12px; padding: 6px 12px; border-radius: 999px;
      background: rgba(15, 23, 42, 0.2);
      border: 1px solid rgba(226, 232, 240, 0.6);
      display: flex; align-items: center; gap: 6px;
    }
    .header-badge span.led {
      width: 8px; height: 8px; border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.35);
    }
    main.app-main {
      display: grid;
      grid-template-columns: 1.6fr 1fr;
      min-height: 520px;
    }
    @media (max-width: 960px) {
      main.app-main { grid-template-columns: 1fr; }
      .project-panel { border-left: none; border-top: 1px solid var(--border); }
    }
    .chat-section {
      display: flex; flex-direction: column;
      padding: 16px;
      background: radial-gradient(circle at top, #e5f9f3, #eef2ff);
    }
    .chat-header-line {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 10px;
    }
    .chat-title {
      font-size: 14px; font-weight: 600;
      display: flex; gap: 8px; align-items: center; color: #0f172a;
    }
    .chat-title span.dot {
      width: 8px; height: 8px; border-radius: 999px; background: #22c55e;
    }
    .chat-sub { font-size: 12px; color: var(--text-soft); }
    .chat-window {
      flex: 1;
      border-radius: var(--radius-lg);
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: var(--shadow-light);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 580px;
    }
    .messages { flex: 1; overflow-y: auto; padding-right: 4px; scroll-behavior: smooth; }
    .message { max-width: 90%; margin-bottom: 8px; display: flex; gap: 8px; }
    .message.assistant { justify-content: flex-start; }
    .message.user { justify-content: flex-end; }
    .bubble {
      padding: 8px 11px;
      border-radius: 14px;
      font-size: 13px;
      line-height: 1.4;
      word-break: break-word;
    }
    .assistant .bubble {
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-bottom-left-radius: 4px;
      color: #0f172a;
    }
    .user .bubble {
      background: #16a34a;
      color: white;
      border-bottom-right-radius: 4px;
    }
    .thinking {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 12px; color: var(--text-soft);
      padding: 4px 8px; border-radius: 999px;
      background: #e5f3ff; margin-top: 2px;
    }
    .thinking-dot {
      width: 6px; height: 6px; border-radius: 999px;
      background: #38bdf8;
      animation: pulse 1.2s infinite ease-in-out;
    }
    .thinking-dot:nth-child(2) { animation-delay: 0.15s; }
    .thinking-dot:nth-child(3) { animation-delay: 0.3s; }
    @keyframes pulse {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1.1); opacity: 1; }
    }
    .chat-input {
      display: flex; align-items: center; gap: 8px;
      margin-top: 8px; padding-top: 8px;
      border-top: 1px solid rgba(148, 163, 184, 0.3);
    }
    .chat-input input[type="text"] {
      flex: 1; padding: 9px 10px; border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 13px; outline: none; background: #f9fafb;
    }
    .chat-input input[type="text"]:focus {
      border-color: #16a34a;
      box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.25);
      background: #ffffff;
    }
    .chat-input button {
      border: none; padding: 9px 14px; border-radius: 999px;
      font-size: 13px; font-weight: 600; cursor: pointer;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: white; display: inline-flex; align-items: center; gap: 6px;
      box-shadow: 0 10px 18px rgba(22, 163, 74, 0.35);
    }
    .chat-input button:disabled {
      opacity: 0.6; cursor: not-allowed; box-shadow: none;
    }
    .project-panel {
      padding: 14px 16px;
      background: #f8fafc;
      border-left: 1px solid rgba(148, 163, 184, 0.35);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .panel-header h2 { font-size: 14px; font-weight: 600; color: #0f172a; }
    .panel-header button {
      border: none;
      background: rgba(15, 118, 110, 0.06);
      color: #0369a1;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    .panel-section {
      background: white;
      border-radius: 14px;
      padding: 8px 10px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.04);
      margin-bottom: 6px;
    }
    .panel-section h3 { font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #0f172a; }
    .panel-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 8px;
      font-size: 11px;
    }
    .panel-label { color: var(--text-soft); }
    .panel-value { font-weight: 600; color: #111827; }
    .pill {
      display: inline-flex;
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 10px;
      margin: 2px 2px 0 0;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #f1f5f9;
    }
    .maliyet { font-size: 20px; font-weight: 700; color: #0f766e; }
    .maliyet-sub { font-size: 11px; color: var(--text-soft); }
    .panel-note { font-size: 11px; color: var(--text-soft); margin-top: 4px; }

    .wizard-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      align-items: flex-start;  /* merkez yerine yukarÄ±dan baÅŸlasÄ±n */
      justify-content: center;
      padding-top: 16px;        /* biraz nefes alanÄ± */
      overflow-y: auto;         /* ekran kÃ¼Ã§Ã¼lÃ¼nce scroll edilebilsin */
      z-index: 10000;           /* her ÅŸeyin ÃœSTÃœNDE olsun */
}
    .wizard-container {
      width: 100%;
      max-width: 660px;
      background: #f9fafb;
      border-radius: 22px;
      padding: 18px 20px 16px;
      box-shadow: 0 24px 55px rgba(15, 23, 42, 0.45);
      border: 1px solid rgba(148, 163, 184, 0.6);
    }
    .wizard-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .wizard-header-left h2 { font-size: 18px; margin-bottom: 4px; color: #0f172a; }
    .wizard-header-left p { font-size: 12px; color: var(--text-soft); }
    .wizard-step-badges {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: #e5f3ff;
      border: 1px solid rgba(59, 130, 246, 0.4);
      height: fit-content;
    }
    .wizard-body {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 12px;
      margin-bottom: 8px;
    }
    @media (max-width: 768px) {
      .wizard-body { grid-template-columns: 1fr; }
    }
    .wizard-form-group { margin-bottom: 8px; }
    .wizard-form-group label {
      font-size: 12px; font-weight: 600;
      display: block; margin-bottom: 4px; color: #111827;
    }
    .wizard-sub { font-size: 11px; color: var(--text-soft); margin-bottom: 4px; }
    .wizard-input {
      width: 100%; padding: 6px 8px; border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      font-size: 12px; outline: none; background: #f9fafb;
    }
    .wizard-range-row { display: flex; align-items: center; gap: 8px; }
    .wizard-range-row input[type="range"] { flex: 1; }
    .wizard-range-value {
      font-size: 12px; font-weight: 600;
      padding: 4px 8px; border-radius: 999px;
      background: #e5f3ff; border: 1px solid rgba(59, 130, 246, 0.4);
    }
    .wizard-options {
      display: flex; flex-wrap: wrap; gap: 6px; margin-top: 2px;
    }
    .wizard-option {
      flex: 1 1 calc(50% - 6px);
      min-width: 90px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 6px 7px;
      font-size: 11px;
      cursor: pointer;
      background: #f8fafc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .wizard-option span.label { font-weight: 500; }
    .wizard-option span.tag { font-size: 10px; color: var(--text-soft); }
    .wizard-option.active {
      background: #dcfce7;
      border-color: #16a34a;
      box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.35);
    }
    .wizard-mini-summary {
      font-size: 11px;
      background: white;
      border-radius: 14px;
      padding: 8px 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.08);
    }
    .wizard-mini-summary h3 { font-size: 11px; font-weight: 600; margin-bottom: 4px; }
    .wizard-mini-summary ul { list-style: none; }
    .wizard-mini-summary li { margin-bottom: 3px; }
    .pill-green {
      display: inline-flex;
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 10px;
      background: #dcfce7;
      border: 1px solid rgba(34, 197, 94, 0.6);
      color: #166534;
      margin-right: 2px;
    }
    .wizard-footer {
      display: flex; justify-content: space-between;
      align-items: center; margin-top: 4px;
      font-size: 11px; color: var(--text-soft);
    }
    .wizard-footer-right { display: flex; gap: 6px; }
    .btn-text {
      border: none; background: transparent;
      font-size: 11px; color: var(--text-soft);
      cursor: pointer; text-decoration: underline;
    }
    .btn-primary {
      border: none;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: white;
      font-size: 13px; font-weight: 600;
      padding: 7px 14px;
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex; align-items: center; gap: 6px;
      box-shadow: 0 14px 24px rgba(22, 163, 74, 0.4);
    }
    .btn-primary:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      box-shadow: none;
    }
  </style>
  <!-- PWA / Manifest -->
<link rel="manifest" href="/manifest.json" />
<meta name="theme-color" content="#16a34a" />

<!-- iOS iÃ§in (Safari ikon ve fullscreen) -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="apple-touch-icon" href="/icons/icon-192.png" />

</head>
<body>

  <!-- Wizard -->
  <div class="wizard-overlay" id="wizardOverlay">
    <div class="wizard-container">
      <div class="wizard-header">
        <div class="wizard-header-left">
          <h2>BahÃ§en iÃ§in hÄ±zlÄ± bir proje tasarlayalÄ±m</h2>
          <p>Ã–nce birkaÃ§ kÄ±sa soru soracaÄŸÄ±m, sonra Sulama AsistanÄ± detaylÄ± tasarÄ±m, malzeme listesi ve maliyet hesabÄ±nÄ± Ã§Ä±karacak.</p>
        </div>
        <div class="wizard-step-badges">1/1 Proje Ã–zeti</div>
      </div>

      <div class="wizard-body">
        <form id="wizardForm">
          <div class="wizard-form-group">
            <label for="areaRange">Alan (mÂ²)</label>
            <p class="wizard-sub">Tahmini alanÄ± girmen yeterli, sonra sohbet iÃ§inde revize edebiliriz.</p>
            <div class="wizard-range-row">
              <input type="range" id="areaRange" min="50" max="2000" step="10" value="200" />
              <div class="wizard-range-value"><span id="areaValue">200</span> mÂ²</div>
            </div>
          </div>

          <div class="wizard-form-group">
            <label>BahÃ§e ÅŸekli</label>
            <div class="wizard-options" data-field="shape">
              <div class="wizard-option active" data-value="dikdortgen">
                <span class="label">DikdÃ¶rtgen</span><span class="tag">En yaygÄ±n</span>
              </div>
              <div class="wizard-option" data-value="L">
                <span class="label">L ÅŸekilli</span><span class="tag">KÃ¶ÅŸe bahÃ§e</span>
              </div>
              <div class="wizard-option" data-value="kare">
                <span class="label">Kare</span><span class="tag">Basit plan</span>
              </div>
              <div class="wizard-option" data-value="serbest">
                <span class="label">Serbest</span><span class="tag">DÃ¼zensiz</span>
              </div>
            </div>
          </div>

          <div class="wizard-form-group">
            <label>Su kaynaÄŸÄ±</label>
            <div class="wizard-options" data-field="waterSource">
              <div class="wizard-option active" data-value="sebekesu">
                <span class="label">Åžebeke suyu</span><span class="tag">Ev su hattÄ±</span>
              </div>
              <div class="wizard-option" data-value="kuyu">
                <span class="label">Kuyu</span><span class="tag">DalgÄ±Ã§ pompa</span>
              </div>
              <div class="wizard-option" data-value="depo">
                <span class="label">Depo + hidrofor</span><span class="tag">BasÄ±nÃ§ kontrollÃ¼</span>
              </div>
              <div class="wizard-option" data-value="sondaj">
                <span class="label">Sondaj</span><span class="tag">YÃ¼ksek debi</span>
              </div>
            </div>
          </div>

          <div class="wizard-form-group">
            <label>BasÄ±nÃ§ bilgisi</label>
            <p class="wizard-sub">Bilmiyorsan sorun deÄŸil, Asistan TÃ¼rkiye ortalamasÄ±na gÃ¶re varsayÄ±lan deÄŸerle hesaplar.</p>
            <div class="wizard-options" data-field="pressureKnown">
              <div class="wizard-option active" data-value="hayir">
                <span class="label">Bilmiyorum</span><span class="tag">Ã–nerilen</span>
              </div>
              <div class="wizard-option" data-value="evet">
                <span class="label">Biliyorum</span><span class="tag">bar cinsinden</span>
              </div>
            </div>
            <input class="wizard-input" type="number" step="0.1" min="0.5" max="8"
                   id="pressureInput" placeholder="Ã–rn: 3.0 bar"
                   style="margin-top:6px; display:none;" />
          </div>

          <div class="wizard-form-group">
            <label>Sistem tipi</label>
            <div class="wizard-options" data-field="systemType">
              <div class="wizard-option active" data-value="sprink">
                <span class="label">Sprink</span><span class="tag">Klasik Ã§im</span>
              </div>
              <div class="wizard-option" data-value="rotor">
                <span class="label">Rotor</span><span class="tag">GeniÅŸ alan</span>
              </div>
              <div class="wizard-option" data-value="damla">
                <span class="label">Damla</span><span class="tag">AÄŸaÃ§ / Ã§alÄ±</span>
              </div>
              <div class="wizard-option" data-value="karisik">
                <span class="label">KarÄ±ÅŸÄ±k</span><span class="tag">Sprink + damla</span>
              </div>
            </div>
          </div>

          <div class="wizard-form-group">
            <label>Otomasyon</label>
            <div class="wizard-options" data-field="automation">
              <div class="wizard-option active" data-value="evet">
                <span class="label">Tam otomatik</span><span class="tag">Programlanabilir cihaz</span>
              </div>
              <div class="wizard-option" data-value="hayir">
                <span class="label">YarÄ± otomatik / manuel</span><span class="tag">Musluk kontrollÃ¼</span>
              </div>
            </div>
          </div>
        </form>

        <div class="wizard-mini-summary" id="wizardSummary">
          <h3>Ã–zet</h3>
          <ul>
            <li><span class="pill-green" id="summaryArea">200 mÂ² alan</span></li>
            <li><span class="pill-green" id="summaryShape">DikdÃ¶rtgen bahÃ§e</span></li>
            <li><span class="pill-green" id="summaryWaterSource">Åžebeke suyu</span></li>
            <li><span class="pill-green" id="summarySystemType">Sprink sistem</span></li>
            <li><span class="pill-green" id="summaryAutomation">Tam otomatik</span></li>
          </ul>
          <p style="margin-top:6px;">Bu bilgilerle Sulama AsistanÄ±:</p>
          <ul style="margin-top:4px; padding-left:14px;">
            <li>Zone sayÄ±sÄ±nÄ± ve boru Ã§aplarÄ±nÄ± hesaplayacak,</li>
            <li>Sprink / damla / rotor adetlerini Ã§Ä±karacak,</li>
            <li>Tahmini malzeme listesi ve maliyet verecek.</li>
          </ul>
        </div>
      </div>

      <div class="wizard-footer">
        <div>Ä°lk etapta tahmini deÄŸerler yeterli. Sohbet sÄ±rasÄ±nda bahÃ§eye Ã¶zel detaylarÄ± netleÅŸtirebiliriz.</div>
        <div class="wizard-footer-right">
          <button type="button" class="btn-text" id="skipWizardBtn">Formu atla</button>
          <button type="button" class="btn-primary" id="startChatBtn">Projeyi baÅŸlat â®•</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Uygulama -->
  <div class="app-shell">
    <header class="app-header">
      <div class="brand">
        <div class="brand-logo">ðŸ’§</div>
        <div class="brand-text">
          <h1>Sulama AsistanÄ±</h1>
          <p>Villa & peyzaj bahÃ§eleri iÃ§in akÄ±llÄ± sulama mÃ¼hendisi</p>
        </div>
      </div>
      <div class="header-badge">
        <span class="led"></span>
        <span>TÃ¼rkiye koÅŸullarÄ±na gÃ¶re hesaplama aktif</span>
      </div>
    </header>

    <main class="app-main">
      <section class="chat-section">
        <div class="chat-header-line">
          <div>
            <div class="chat-title">
              <span class="dot"></span><span>Proje Sohbeti</span>
            </div>
            <div class="chat-sub">BahÃ§en hakkÄ±nda soru sorabilir, Ã§Ä±ktÄ±larÄ± revize ettirebilirsin.</div>
          </div>
        </div>

        <div class="chat-window">
          <div class="messages" id="messages"></div>

          <div id="thinkingIndicator" style="display:none; margin-bottom:6px;">
            <div class="thinking">
              <span>Sulama AsistanÄ± dÃ¼ÅŸÃ¼nÃ¼yor</span>
              <span class="thinking-dot"></span>
              <span class="thinking-dot"></span>
              <span class="thinking-dot"></span>
            </div>
          </div>

          <form id="chatForm" class="chat-input">
            <input type="text" id="userInput"
                   placeholder="Ã–rn: 200 mÂ² L bahÃ§em var, zone ve malzeme hesabÄ±nÄ± detaylÄ± Ã§Ä±karÄ±r mÄ±sÄ±n?"
                   autocomplete="off" />
            <button type="submit" id="sendBtn">GÃ¶nder â®ž</button>
          </form>
        </div>
      </section>

      <aside class="project-panel">
        <div class="panel-header">
          <h2>Proje Ã–zeti</h2>
          <button type="button" id="editWizardBtn">Bilgileri gÃ¼ncelle</button>
        </div>

        <div class="panel-section">
          <h3>Temel Bilgiler</h3>
          <div class="panel-grid">
            <div class="panel-label">Alan</div><div class="panel-value" id="panelArea">â€“</div>
            <div class="panel-label">Åžekil</div><div class="panel-value" id="panelShape">â€“</div>
            <div class="panel-label">Su kaynaÄŸÄ±</div><div class="panel-value" id="panelWaterSource">â€“</div>
            <div class="panel-label">BasÄ±nÃ§</div><div class="panel-value" id="panelPressure">VarsayÄ±lan</div>
            <div class="panel-label">Sistem tipi</div><div class="panel-value" id="panelSystemType">â€“</div>
            <div class="panel-label">Otomasyon</div><div class="panel-value" id="panelAutomation">â€“</div>
          </div>
        </div>

        <div class="panel-section">
          <h3>TasarÄ±m & Zone Bilgisi (AI)</h3>
          <div class="panel-grid">
            <div class="panel-label">Tahmini zone</div><div class="panel-value" id="panelZones">â€“</div>
            <div class="panel-label">Ana boru Ã§apÄ±</div><div class="panel-value" id="panelMainPipe">â€“</div>
            <div class="panel-label">Lateral Ã§ap</div><div class="panel-value" id="panelLateralPipe">â€“</div>
            <div class="panel-label">Sprink / rotor adedi</div><div class="panel-value" id="panelSprinkCount">â€“</div>
            <div class="panel-label">Damla hat uzunluÄŸu</div><div class="panel-value" id="panelDripLength">â€“</div>
            <div class="panel-label">Vana kutusu sayÄ±sÄ±</div><div class="panel-value" id="panelValveBoxes">â€“</div>
          </div>
          <p class="panel-note">Åžu an baÅŸlangÄ±Ã§ varsayÄ±mlarÄ±nÄ± gÃ¶steriyor; AI teklif cevabÄ±na gÃ¶re otomatik gÃ¼ncellenecek.</p>
        </div>

        <div class="panel-section">
          <h3>Maliyet Ã–zeti (AI tahmin)</h3>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px;">
            <div>
              <div class="maliyet" id="panelTotalCost">â€“</div>
              <div class="maliyet-sub" id="panelCostNote">Malzeme + iÅŸÃ§ilik tahmini</div>
            </div>
            <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
              <span class="pill">DetaylÄ± listeyi chat cevabÄ±nda gÃ¶receksin</span>
              <button type="button" id="downloadOfferBtn"
                      style="display:none; padding:6px 10px; border-radius:999px; border:1px solid rgba(148,163,184,0.7); background:#0f766e; color:#fff; font-size:11px; cursor:pointer;">
                Teklif formunu indir (PDF)
              </button>
            </div>
          </div>
          <p class="panel-note">Bu rakam, AI teklif listesinden otomatik hesaplanÄ±r; istersen PDF olarak indirebilirsin.</p>
        </div>
      </aside>
    </main>
  </div>

  <script>
  // ======== Proje durumu =========
  const projectState = {
    area: 200,
    shape: "dikdortgen",
    waterSource: "sebekesu",
    pressureKnown: false,
    pressure: null,
    systemType: "sprink",
    automation: "evet",
    zones: null,
    mainPipe: null,
    lateralPipe: null,
    sprinkCount: null,
    dripLength: null,
    valveBoxes: null,
    totalCost: null,
    totalCostNote: "Malzeme + iÅŸÃ§ilik tahmini"
  };

  // Son teklif metni ve teklif isteÄŸi regex'i
  let lastOfferText = "";
  const OFFER_LIST_REGEX =
    /(malzeme listesi|tam malzeme|Ã¼rÃ¼n Ã¼rÃ¼[nm]|urun urun|liste olarak|liste halinde|kalem kalem|teklif formu|teklif Ã§Ä±kar|teklif cikar|fiyatlandÄ±r|fiyatlandir|fiyatlÄ± liste|kac metre|kaÃ§ metre|kac adet|kaÃ§ adet|net yaz|net liste)/i;

  // DOM referanslarÄ±
  const wizardOverlay = document.getElementById("wizardOverlay");
  const areaRange = document.getElementById("areaRange");
  const areaValue = document.getElementById("areaValue");
  const summaryArea = document.getElementById("summaryArea");
  const summaryShape = document.getElementById("summaryShape");
  const summaryWaterSource = document.getElementById("summaryWaterSource");
  const summarySystemType = document.getElementById("summarySystemType");
  const summaryAutomation = document.getElementById("summaryAutomation");
  const pressureInput = document.getElementById("pressureInput");
  const startChatBtn = document.getElementById("startChatBtn");
  const skipWizardBtn = document.getElementById("skipWizardBtn");
  const editWizardBtn = document.getElementById("editWizardBtn");

  const panelArea = document.getElementById("panelArea");
  const panelShape = document.getElementById("panelShape");
  const panelWaterSource = document.getElementById("panelWaterSource");
  const panelPressure = document.getElementById("panelPressure");
  const panelSystemType = document.getElementById("panelSystemType");
  const panelAutomation = document.getElementById("panelAutomation");
  const panelZones = document.getElementById("panelZones");
  const panelMainPipe = document.getElementById("panelMainPipe");
  const panelLateralPipe = document.getElementById("panelLateralPipe");
  const panelSprinkCount = document.getElementById("panelSprinkCount");
  const panelDripLength = document.getElementById("panelDripLength");
  const panelValveBoxes = document.getElementById("panelValveBoxes");
  const panelTotalCost = document.getElementById("panelTotalCost");
  const panelCostNote = document.getElementById("panelCostNote");
  const downloadOfferBtn = document.getElementById("downloadOfferBtn");

  const messagesDiv = document.getElementById("messages");
  const chatForm = document.getElementById("chatForm");
  const userInput = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");
  const thinkingIndicator = document.getElementById("thinkingIndicator");

  // ========= YardÄ±mcÄ±lar =========
  function updateProjectPanel() {
    panelArea.textContent = projectState.area ? projectState.area + " mÂ²" : "â€“";
    const shapeMap = { dikdortgen: "DikdÃ¶rtgen", L: "L ÅŸekilli", kare: "Kare", serbest: "Serbest" };
    panelShape.textContent = shapeMap[projectState.shape] || "â€“";
    const waterMap = { sebekesu: "Åžebeke suyu", kuyu: "Kuyu", depo: "Depo + hidrofor", sondaj: "Sondaj" };
    panelWaterSource.textContent = waterMap[projectState.waterSource] || "â€“";

    if (projectState.pressureKnown && projectState.pressure) {
      panelPressure.textContent = projectState.pressure.toFixed(1) + " bar";
    } else {
      panelPressure.textContent = "VarsayÄ±lan (â‰ˆ3 bar)";
    }

    const sysMap = { sprink: "Sprink", rotor: "Rotor", damla: "Damla", karisik: "KarÄ±ÅŸÄ±k" };
    panelSystemType.textContent = sysMap[projectState.systemType] || "â€“";
    panelAutomation.textContent = projectState.automation === "evet" ? "Tam otomatik" : "YarÄ± otomatik / manuel";

    panelZones.textContent = projectState.zones != null ? projectState.zones : "â€“";
    panelMainPipe.textContent = projectState.mainPipe || "â€“";
    panelLateralPipe.textContent = projectState.lateralPipe || "â€“";
    panelSprinkCount.textContent = projectState.sprinkCount != null ? projectState.sprinkCount : "â€“";
    panelDripLength.textContent = projectState.dripLength || "â€“";
    panelValveBoxes.textContent = projectState.valveBoxes != null ? projectState.valveBoxes : "â€“";

    if (projectState.totalCost != null) {
      panelTotalCost.textContent = projectState.totalCost.toLocaleString("tr-TR") + " TL";
    } else {
      panelTotalCost.textContent = "â€“";
    }
    panelCostNote.textContent = projectState.totalCostNote || "Malzeme + iÅŸÃ§ilik tahmini";
  }

  function parseNumberTR(str) {
    if (!str) return null;
    const clean = str.replace(/\./g, "").replace(/\s/g, "");
    const n = parseInt(clean, 10);
    return isNaN(n) ? null : n;
  }

  // Teklif cevabÄ±ndan panel iÃ§in bilgi Ã§ek
  function analyzeOfferText(text) {
    if (!text) return;

    // Toplam yaklaÅŸÄ±k fiyat
    let m = text.match(/Toplam yaklaÅŸÄ±k:\s*([\d\.]+)\s*[â€“-]\s*([\d\.]+)\s*TL/i);
    if (m) {
      const n1 = parseNumberTR(m[1]);
      const n2 = parseNumberTR(m[2]);
      if (n1 && n2) {
        projectState.totalCost = Math.round((n1 + n2) / 2);
        projectState.totalCostNote =
          `Malzeme iÃ§in yaklaÅŸÄ±k ${n1.toLocaleString("tr-TR")}â€“${n2.toLocaleString(
            "tr-TR"
          )} TL (iÅŸÃ§ilik hariÃ§).`;
      }
    } else {
      m = text.match(/Toplam yaklaÅŸÄ±k:\s*([\d\.]+)\s*TL/i);
      if (m) {
        const n = parseNumberTR(m[1]);
        if (n) {
          projectState.totalCost = n;
          projectState.totalCostNote = "Malzeme iÃ§in yaklaÅŸÄ±k toplam (iÅŸÃ§ilik hariÃ§).";
        }
      }
    }

    // Zone sayÄ±sÄ±
    const zoneMatch = text.match(/(\d+)\s*zone[â€™'lu]*/i);
    if (zoneMatch) projectState.zones = parseInt(zoneMatch[1], 10);

    // Rotor / sprink adedi
    let rotorMatch = text.match(/(\d+)\s*adet\s+[^.\n]*rotor/i);
    if (!rotorMatch) rotorMatch = text.match(/(\d+)\s*x\s+[^.\n]*rotor/i);
    if (!rotorMatch) rotorMatch = text.match(/toplam\s+(\d+)\s+adet\s+rotor/i);
    if (rotorMatch) projectState.sprinkCount = parseInt(rotorMatch[1], 10);

    // Ana hat boru
    const mainMatch = text.match(/(\d+)\s*m\s+PE\s*1?00?\s*(\d+)\s*mm[^.\n]*ana/i);
    if (mainMatch) projectState.mainPipe = `${mainMatch[1]} m PE ${mainMatch[2]} mm`;

    // Lateral boru
    const latMatch = text.match(/(\d+)\s*m\s+PE\s*1?00?\s*(\d+)\s*mm[^.\n]*(lateral|yan hat|zone iÃ§i)/i);
    if (latMatch) projectState.lateralPipe = `${latMatch[1]} m PE ${latMatch[2]} mm`;

    // Vana kutusu
    const valveMatch = text.match(/(\d+)\s*adet[^.\n]*vana kutusu/i);
    if (valveMatch) projectState.valveBoxes = parseInt(valveMatch[1], 10);

    // Basit defaultlar
    if (!projectState.mainPipe) {
      projectState.mainPipe = "â‰ˆ PE 32 mm ana hat (Ã¶nerilen)";
    }
    if (!projectState.lateralPipe) {
      projectState.lateralPipe = "â‰ˆ PE 20 mm lateral (Ã¶nerilen)";
    }
    if (projectState.sprinkCount == null && projectState.systemType === "rotor" && projectState.area) {
      projectState.sprinkCount = Math.max(4, Math.round(projectState.area / 18));
    }

    updateProjectPanel();
  }

  // Teklif metnini maddelere bÃ¶len yardÄ±mcÄ±
  function splitOfferText(text) {
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
    const items = [];
    let totalLine = null;
    const otherLines = [];

    for (const line of lines) {
      if (/Toplam yaklaÅŸÄ±k/i.test(line)) {
        totalLine = line;
        continue;
      }
      if (/^\d+\)/.test(line)) {
        items.push(line);
      } else {
        otherLines.push(line);
      }
    }
    return { items, totalLine, otherLines };
  }

  // PDF Ã¼ret
  // Teklif metnini maddelere bÃ¶len yardÄ±mcÄ± (zaten ekli deÄŸilse yukarÄ±daki splitOfferText duruyor)
function generateOfferPdf() {
  if (!lastOfferText) {
    alert("Ã–nce bir teklif listesi oluÅŸturmalÄ±sÄ±n.");
    return;
  }

  const jspdf = window.jspdf;
  if (!jspdf || !jspdf.jsPDF) {
    alert("PDF modÃ¼lÃ¼ yÃ¼klenemedi (jsPDF).");
    return;
  }
  const { jsPDF } = jspdf;
  const doc = new jsPDF("p", "mm", "a4");

  // Roboto fontu kullan
try {
  doc.setFont("Roboto", "normal");
} catch (e) {
  // Font adÄ± farklÄ±ysa converter dosyasÄ±ndaki addFont satÄ±rÄ±na bak
  console.warn("Roboto font set edilemedi, default font kullanÄ±lÄ±yor:", e);
}


  if (typeof doc.autoTable !== "function") {
    alert("Tablo modÃ¼lÃ¼ yÃ¼klenemedi (autoTable).");
    return;
  }

  const { items, totalLine } = splitOfferText(lastOfferText);

  let y = 15;

  // ===== BaÅŸlÄ±k =====
  doc.setFontSize(15);
  doc.text("ToptanSulama.com - Sulama Proje ve Malzeme Teklifi", 12, y);
  y += 8;

  // Firma & tarih
  doc.setFontSize(10);
  const today = new Date();
  const dateStr = today.toLocaleDateString("tr-TR");
  doc.text("Firma: ToptanSulama.com", 12, y);
  doc.text("Tarih: " + dateStr, 200 - 12, y, { align: "right" });
  y += 6;

  doc.setLineWidth(0.3);
  doc.line(12, y, 200 - 12, y);
  y += 6;

  // ===== Proje bilgileri kutusu =====
  doc.setFontSize(11);
  doc.text("Proje Bilgileri", 12, y);
  y += 5;
  doc.setLineWidth(0.2);
  doc.roundedRect(12, y, 200 - 24, 24, 2, 2);
  y += 6;

  const projLines = [
    `Alan: ${projectState.area || "-"} mÂ²`,
    `Åžekil: ${panelShape.textContent || "-"}`,
    `Su kaynaÄŸÄ±: ${panelWaterSource.textContent || "-"}`,
    `Sistem tipi: ${panelSystemType.textContent || "-"}`,
    `Otomasyon: ${panelAutomation.textContent || "-"}`
  ];

  doc.setFontSize(10);
  let innerY = y;
  projLines.forEach((line) => {
    doc.text(line, 14, innerY);
    innerY += 4.5;
  });
  y += 24 + 6;

  // ===== Malzeme tablosu =====
  doc.setFontSize(11);
  doc.text("Malzeme Kalemleri", 12, y);
  y += 4;
  doc.setLineWidth(0.2);
  doc.line(12, y, 200 - 12, y);
  y += 2;

  // Kalemleri tabloya hazÄ±rlama
  const rows = items.map((raw, idx) => {
    // "7) ..." baÅŸÄ±ndaki numarayÄ± at
    let line = raw.replace(/^\d+\)\s*/, "").trim();

    // Fiyat parÃ§asÄ±
    let priceText = "";
    const priceMatch = line.match(/YaklaÅŸÄ±k fiyat\s*\(([^)]+)\)/i);
    if (priceMatch) {
      priceText = priceMatch[1].trim(); // "80 x 14 TL â‰ˆ 1.120 TL"
      line = line.replace(/[-â€“]\s*YaklaÅŸÄ±k fiyat\s*\([^)]+\)/i, "").trim();
    }

    // Tahmini adet (ilk "x" Ã¶ncesi sayÄ± veya "adet")
    let adet = "";
    let adetMatch = line.match(/(\d+)\s*x/i);
    if (!adetMatch) adetMatch = line.match(/(\d+)\s*adet/i);
    if (adetMatch) adet = adetMatch[1];

    // AÃ§Ä±klama (Ã¼rÃ¼n / iÅŸ iÃ§eriÄŸi)
    const desc = line;

    return [
      String(idx + 1),    // #
      desc,               // AÃ§Ä±klama
      adet,               // Adet
      priceText           // YaklaÅŸÄ±k fiyat
    ];
  });

  doc.autoTable({
    head: [["#", "ÃœrÃ¼n / AÃ§Ä±klama", "Adet", "YaklaÅŸÄ±k fiyat"]],
    body: rows,
    startY: y + 2,
    styles: {
  fontSize: 8.5,
  cellPadding: 2,
  valign: "top"
},
    headStyles: {
      fillColor: [15, 118, 110],
      textColor: 255,
      halign: "center"
    },
    columnStyles: {
  0: { cellWidth: 8, halign: "center" },   // # kolonu
  1: { cellWidth: 110 },                   // ÃœrÃ¼n / aÃ§Ä±klama
  2: { cellWidth: 16, halign: "center" },  // Adet
  3: { cellWidth: 40, halign: "right" }    // YaklaÅŸÄ±k fiyat
},

    theme: "grid",
    alternateRowStyles: { fillColor: [245, 245, 245] }
  });

  const tableY = doc.lastAutoTable.finalY || (y + 30);
  let currY = tableY + 8;

  // ===== Toplam satÄ±rÄ± =====
  doc.setFontSize(11);
  let totalText = "";
  if (totalLine) {
    totalText = totalLine.replace(/^Toplam yaklaÅŸÄ±k:\s*/i, "");
  } else if (projectState.totalCost != null) {
    totalText = projectState.totalCost.toLocaleString("tr-TR") + " TL";
  }

  if (totalText) {
    doc.setFontSize(11);
    doc.text("Toplam yaklaÅŸÄ±k:", 12, currY);
    doc.setFontSize(12);
    doc.text(totalText, 200 - 12, currY, { align: "right" });
    currY += 8;
  }

  // ===== Notlar =====
  const noteLines = [
    "Not: Bu teklif yaklaÅŸÄ±k deÄŸerler iÃ§erir; stok durumu, kur ve tedarikÃ§ilere gÃ¶re deÄŸiÅŸebilir.",
    "Not: Ä°ÅŸÃ§ilik kalemleri belirtilmemiÅŸse sadece malzeme bedeli dikkate alÄ±nmalÄ±dÄ±r.",
    "Bu PDF, Sulama AsistanÄ± tarafÄ±ndan otomatik oluÅŸturulmuÅŸtur."
  ];
  doc.setFontSize(9);
  noteLines.forEach((line) => {
    if (currY > 280) {
      doc.addPage();
      currY = 15;
    }
    const split = doc.splitTextToSize(line, 200 - 24);
    split.forEach((l) => {
      doc.text(l, 12, currY);
      currY += 4;
    });
  });

  doc.save("sulama-teklifi.pdf");
}


  function updateWizardSummary() {
    summaryArea.textContent = projectState.area + " mÂ² alan";
    const shapeTextMap = {
      dikdortgen: "DikdÃ¶rtgen bahÃ§e",
      L: "L ÅŸekilli bahÃ§e",
      kare: "Kare bahÃ§e",
      serbest: "Serbest form"
    };
    summaryShape.textContent = shapeTextMap[projectState.shape] || "BahÃ§e ÅŸekli";
    const waterTextMap = {
      sebekesu: "Åžebeke suyu",
      kuyu: "Kuyu",
      depo: "Depo + hidrofor",
      sondaj: "Sondaj"
    };
    summaryWaterSource.textContent = waterTextMap[projectState.waterSource] || "Su kaynaÄŸÄ±";
    const sysTextMap = {
      sprink: "Sprink sistem",
      rotor: "Rotor sistem",
      damla: "Damla sulama",
      karisik: "KarÄ±ÅŸÄ±k sistem"
    };
    summarySystemType.textContent = sysTextMap[projectState.systemType] || "Sistem tipi";
    summaryAutomation.textContent =
      projectState.automation === "evet" ? "Tam otomatik" : "YarÄ± otomatik / manuel";
  }

  function renderBubbleText(bubble, text) {
    const safe = (text || "").toString();
    bubble.innerHTML = safe.replace(/\n/g, "<br>");
  }

  function addMessage(role, text) {
    const wrapper = document.createElement("div");
    wrapper.className = "message " + role;
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    renderBubbleText(bubble, text);
    wrapper.appendChild(bubble);
    messagesDiv.appendChild(wrapper);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    return bubble;
  }

  function setThinking(isThinking) {
    thinkingIndicator.style.display = isThinking ? "block" : "none";
    userInput.disabled = isThinking;
    sendBtn.disabled = isThinking;
    if (!isThinking) userInput.focus();
  }

  function buildPromptFromProject(userText) {
    const wantsList = OFFER_LIST_REGEX.test(userText);
    const wantsDetailRegex =
      /(detaylÄ± anlat|detayli anlat|detaylÄ± yaz|detayli yaz|uzun uzun|hidrolik hesap|basÄ±nÃ§ kaybÄ± hesabÄ±|basinc kaybi hesabi|hesap yap|hesabÄ±nÄ± Ã§Ä±kar|hesabini cikar|metraj Ã§Ä±kar|metraj cikar)/i;
    const wantsDetail = !wantsList && wantsDetailRegex.test(userText);

    let intro = "BahÃ§e iÃ§in elimde ÅŸu Ã¶n bilgiler var:\n";
    intro += " - Alan: " + (projectState.area ? projectState.area + " mÂ²" : "bilinmiyor") + "\n";

    const shapeMap = { dikdortgen: "dikdÃ¶rtgen", L: "L ÅŸekilli", kare: "kare", serbest: "serbest form" };
    intro += " - Åžekil: " + (shapeMap[projectState.shape] || "belirtilmedi") + "\n";

    const waterMap = { sebekesu: "ÅŸebeke suyu", kuyu: "kuyu", depo: "depo + hidrofor", sondaj: "sondaj" };
    intro += " - Su kaynaÄŸÄ±: " + (waterMap[projectState.waterSource] || "bilinmiyor") + "\n";

    const sysMap = { sprink: "sprink", rotor: "rotor", damla: "damla", karisik: "karÄ±ÅŸÄ±k" };
    intro += " - Sistem tipi: " + (sysMap[projectState.systemType] || "belirtilmedi") + "\n";

    intro +=
      " - Otomasyon: " +
      (projectState.automation === "evet" ? "tam otomatik" : "yarÄ± otomatik / manuel") +
      "\n";

    let hint = "";
    if (wantsList) {
      hint += "KURAL: KullanÄ±cÄ± net MALZEME LÄ°STESÄ° ve TEKLÄ°F istiyor.\n";
      hint += "Girizgah, Ã¶zet, 'istersen', 'bir sonraki adÄ±mda' gibi cÃ¼mleler YASAK.\n";
      hint += "Cevap formatÄ±n ÅžÃ–YLE OLACAK:\n";
      hint += "1) En fazla 1 cÃ¼mlelik Ã§ok kÄ±sa Ã¶zet.\n";
      hint +=
        "2) Hemen altÄ±nda madde madde liste; her satÄ±rda: 'Adet x ÃœrÃ¼n adÄ± â€“ kÄ±sa aÃ§Ä±klama â€“ YaklaÅŸÄ±k fiyat (X TL)'. En fazla 20 satÄ±r.\n";
      hint +=
        "3) Listenin en altÄ±nda tek satÄ±rda: 'Toplam yaklaÅŸÄ±k: Xâ€“Y TL (malzeme, iÅŸÃ§ilik hariÃ§/dahil)'.\n";
      hint += "BaÅŸka aÃ§Ä±klama, soru, davet YAZMA.\n";
    } else if (wantsDetail) {
      hint += "KURAL: KullanÄ±cÄ± detaylÄ± TEKNÄ°K aÃ§Ä±klama istiyor.\n";
      hint += "2â€“5 kÄ±sa paragraf kullan; her paragraf en fazla 3 cÃ¼mle olsun.\n";
      hint += "Zone planÄ±, boru Ã§apÄ±, debi ve basÄ±nÃ§ hesabÄ±nÄ± adÄ±m adÄ±m ama roman yazmadan aÃ§Ä±kla.\n";
    } else {
      hint += "KURAL: Bu mesaja EN FAZLA 3 cÃ¼mleyle kÄ±sa cevap ver.\n";
      hint += "Madde, baÅŸlÄ±k, tablo, uzun teknik aÃ§Ä±klama, fiyat listesi YASAK.\n";
      hint += "Gerekiyorsa sadece 1 tane netleÅŸtirici soru sor, sonra dur.\n";
    }

    return intro + "\n" + hint + "\nKULLANICI MESAJI:\n" + userText;
  }

  // ========= Wizard eventleri =========
  areaRange.addEventListener("input", () => {
    const val = parseInt(areaRange.value, 10);
    projectState.area = val;
    areaValue.textContent = val;
    updateWizardSummary();
  });

  document.querySelectorAll(".wizard-options").forEach((group) => {
    const field = group.getAttribute("data-field");
    group.addEventListener("click", (e) => {
      const option = e.target.closest(".wizard-option");
      if (!option) return;
      group.querySelectorAll(".wizard-option").forEach((o) => o.classList.remove("active"));
      option.classList.add("active");
      const value = option.getAttribute("data-value");
      if (!value) return;

      if (field === "shape") projectState.shape = value;
      else if (field === "waterSource") projectState.waterSource = value;
      else if (field === "pressureKnown") {
        projectState.pressureKnown = value === "evet";
        pressureInput.style.display = projectState.pressureKnown ? "block" : "none";
        if (!projectState.pressureKnown) projectState.pressure = null;
      } else if (field === "systemType") projectState.systemType = value;
      else if (field === "automation") projectState.automation = value;

      updateWizardSummary();
    });
  });

  pressureInput.addEventListener("input", () => {
    const val = parseFloat(pressureInput.value.replace(",", "."));
    if (!isNaN(val)) projectState.pressure = val;
  });

  startChatBtn.addEventListener("click", () => {
    wizardOverlay.style.display = "none";
    updateProjectPanel();
    addMessage(
      "assistant",
      "BahÃ§e bilgilerini aldÄ±m. Alan: " +
        projectState.area +
        " mÂ², ÅŸekil: " +
        ({ dikdortgen: "dikdÃ¶rtgen", L: "L", kare: "kare", serbest: "serbest" }[projectState.shape] ||
          "belirtilmemiÅŸ") +
        ", su kaynaÄŸÄ±: " +
        ({ sebekesu: "ÅŸebeke suyu", kuyu: "kuyu", depo: "depo + hidrofor", sondaj: "sondaj" }[
          projectState.waterSource
        ] || "belirtilmemiÅŸ") +
        ". Åžimdi bu bilgilere gÃ¶re zone planÄ±, boru Ã§aplarÄ± ve malzeme listesini Ã§Ä±karabiliriz. Ä°stersen bahÃ§enin Ã¶zel durumlarÄ±nÄ± (aÄŸaÃ§, teras, eÄŸim vb.) yaz."
    );
    userInput.focus();
  });

  skipWizardBtn.addEventListener("click", () => {
    wizardOverlay.style.display = "none";
    addMessage(
      "assistant",
      "HoÅŸ geldin. BahÃ§e alanÄ±nÄ±, su kaynaÄŸÄ±nÄ± ve otomasyon isteÄŸini yazdÄ±ÄŸÄ±nda sana Ã¶zel sulama projesi, malzeme listesi ve maliyet hesabÄ± Ã§Ä±karacaÄŸÄ±m."
    );
    updateProjectPanel();
    userInput.focus();
  });

  editWizardBtn.addEventListener("click", () => {
    wizardOverlay.style.display = "flex";
  });

  downloadOfferBtn.addEventListener("click", generateOfferPdf);

  // ========= Chat (streaming) =========
  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = userInput.value.trim();
    if (!text) return;

    const isOfferRequest = OFFER_LIST_REGEX.test(text);

    addMessage("user", text);
    userInput.value = "";
    setThinking(true);

    const assistantBubble = addMessage("assistant", "");
    const combinedMessage = buildPromptFromProject(text);
    let assistantText = "";

    try {
      const response = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: combinedMessage,
          user: { email: "guest@sulamaasistani.local" }
        })
      });

      if (!response.ok || !response.body) {
        throw new Error("Sunucudan geÃ§ersiz yanÄ±t alÄ±ndÄ±: " + response.status);
      }

      const reader = response.body.getReader();
      const decoder = new TextDecoder("utf-8");

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });
        assistantText += chunk;
        renderBubbleText(assistantBubble, assistantText);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    } catch (err) {
      console.error(err);
      renderBubbleText(
        assistantBubble,
        "Bir hata oluÅŸtu: " + err.message + ". LÃ¼tfen daha sonra tekrar dener misin veya sistem yÃ¶neticine bildir."
      );
    } finally {
      setThinking(false);

      if (isOfferRequest && assistantText) {
        lastOfferText = assistantText;
        analyzeOfferText(assistantText);
        downloadOfferBtn.style.display = "inline-flex";
      }
    }
  });

  // BaÅŸlangÄ±Ã§
  updateWizardSummary();
  updateProjectPanel();
</script>

<div id="beta-warning" 
     style="
        width: 100%;
        padding: 10px 18px;
        background: #fff7d6;
        border-bottom: 1px solid #f0d98c;
        color: #5e4a1b;
        font-size: 13px;
        font-family: system-ui, sans-serif;
        text-align: center;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 9999; /* ÃœSTE sabit */
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
     ">
    ðŸ§ª <strong>Sulama AsistanÄ± Beta SÃ¼rÃ¼mÃ¼</strong>

    <button onclick="document.getElementById('beta-warning').style.display='none'; 
                     document.body.style.paddingTop='0px';"
            style="
                background: none;
                border: none;
                cursor: pointer;
                color: #7a5f2a;
                text-decoration: underline;
                font-size: 12px;
            ">
        Kapat
    </button>
</div>


<script>
  // --- Beta bar Ã¼st konuma alÄ±ndÄ±ÄŸÄ± iÃ§in sayfaya boÅŸluk ekle ---
  document.body.style.paddingTop = "48px";

  // --- Beta bar kapatma fonksiyonu ---
  function closeBetaWarning() {
    const bar = document.getElementById("beta-warning");
    if (bar) {
      bar.style.display = "none";
      document.body.style.paddingTop = "0px";
    }
  }

  // --- PWA Service Worker kaydÄ± ---
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker
        .register("/sw.js")
        .then((reg) => {
          console.log("Service worker kayÄ±tlÄ±:", reg.scope);
        })
        .catch((err) => {
          console.log("Service worker kaydÄ± baÅŸarÄ±sÄ±z:", err);
        });
    });
  }
</script>

</body>
</html>

</body>
</html>
